<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Women AI - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Login Screen */
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            margin: 100px auto;
            display: none;
        }

        .login-box.active {
            display: block;
        }

        .login-box h1 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            margin-top: 10px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        /* Admin Panel */
        .admin-panel {
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
        }

        .header .user-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .logout-btn {
            padding: 10px 20px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #ee5a6f;
            transform: scale(1.05);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }

        .settings-grid {
            display: grid;
            gap: 20px;
        }

        .settings-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .settings-card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 22px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }

        .alert.active {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .blacklist-manager {
            margin-top: 20px;
        }

        .blacklist-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            min-height: 50px;
            padding: 15px;
            border: 2px dashed #e0e0e0;
            border-radius: 10px;
        }

        .tag {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            line-height: 1;
        }

        .tag .remove:hover {
            color: #ff6b6b;
        }

        .add-blacklist {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .add-blacklist input {
            flex: 1;
        }

        .add-blacklist button {
            width: auto;
            padding: 12px 30px;
        }

        .range-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .range-group input[type="range"] {
            flex: 1;
        }

        .range-value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: #667eea;
            font-size: 18px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }
        }

        .emoji {
            font-size: 24px;
            margin-right: 8px;
        }

        /* =========== TAB NAVƒ∞GASYON =========== */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .tab-btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            background: transparent;
            color: #666;
            transition: all 0.3s;
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .tab-btn:hover:not(.active) { background: #f0f0f0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* =========== DASHBOARD KARTLARI =========== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .dash-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .dash-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        .dash-card.green::before { background: linear-gradient(135deg, #38ef7d, #11998e); }
        .dash-card.orange::before { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .dash-card.blue::before { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .dash-card .dash-icon { font-size: 28px; margin-bottom: 8px; }
        .dash-card .dash-value { font-size: 32px; font-weight: 800; color: #333; }
        .dash-card .dash-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }
        .dash-card .dash-change { font-size: 12px; margin-top: 6px; font-weight: 600; }
        .dash-card .dash-change.up { color: #38ef7d; }
        .dash-card .dash-change.down { color: #f5576c; }

        /* CHART CONTAINERS */
        .chart-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        .chart-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        .chart-box h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .bar-chart {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 160px;
            padding-top: 10px;
        }
        .bar-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: flex-end;
        }
        .bar {
            width: 100%;
            max-width: 30px;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 4px 4px 0 0;
            min-height: 2px;
            transition: height 0.5s;
            position: relative;
        }
        .bar:hover { opacity: 0.8; }
        .bar-label {
            font-size: 9px;
            color: #999;
            margin-top: 4px;
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            max-height: 40px;
            overflow: hidden;
        }
        .bar-value {
            font-size: 9px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 2px;
        }

        /* PIE / DONUT CHART (CSS) */
        .donut-chart {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            margin: 0 auto 15px;
            position: relative;
        }
        .donut-center {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            width: 80px; height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            color: #333;
        }
        .legend { display: flex; flex-direction: column; gap: 6px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #555; }
        .legend-dot { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }

        /* Heatmap */
        .heatmap {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 3px;
        }
        .heat-cell {
            aspect-ratio: 1;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: white;
            font-weight: 600;
            min-height: 28px;
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        .data-table th {
            color: #888;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }
        .data-table tr:hover td { background: #f8f8ff; }
        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px; height: 24px;
            border-radius: 50%;
            font-size: 11px;
            font-weight: 700;
            color: white;
        }

        /* Period selector */
        .period-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .period-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            color: #666;
            transition: all 0.3s;
        }
        .period-btn.active {
            border-color: #667eea;
            color: #667eea;
            background: rgba(102,126,234,0.08);
        }

        @media (max-width: 768px) {
            .chart-row { grid-template-columns: 1fr; }
            .tab-nav { flex-wrap: wrap; }
            .tab-btn { font-size: 13px; padding: 10px; }
            .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
            .heatmap { gap: 2px; }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div id="loading" class="loading">
        <div>Y√ºkleniyor...</div>
    </div>

    <!-- Login Screen -->
    <div id="loginBox" class="login-box">
        <h1>üîê Admin Giri≈üi</h1>
        <div id="loginAlert" class="alert"></div>
        <form id="loginForm">
            <div class="input-group">
                <label for="username">Kullanƒ±cƒ± Adƒ±</label>
                <input type="text" id="username" required autocomplete="username">
            </div>
            <div class="input-group">
                <label for="password">≈ûifre</label>
                <input type="password" id="password" required autocomplete="current-password">
            </div>
            <button type="submit" class="btn">Giri≈ü Yap</button>
        </form>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-panel">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>üë©‚Äçüíº Women AI Admin Panel</h1>
                <div class="user-info">
                    <span id="welcomeText">Ho≈ü geldin, Admin!</span>
                    <button class="logout-btn" onclick="logout()">√áƒ±kƒ±≈ü Yap</button>
                </div>
            </div>

            <!-- Alert -->
            <div id="mainAlert" class="alert"></div>

            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
                <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è Ayarlar</button>
            </div>

            <!-- ==================== DASHBOARD TAB ==================== -->
            <div id="tab-dashboard" class="tab-content active">

                <!-- Period Selector -->
                <div class="period-selector">
                    <button class="period-btn" onclick="loadChatStats(7)" data-period="7">7 G√ºn</button>
                    <button class="period-btn active" onclick="loadChatStats(30)" data-period="30">30 G√ºn</button>
                    <button class="period-btn" onclick="loadChatStats(90)" data-period="90">90 G√ºn</button>
                </div>

                <!-- Summary Cards -->
                <div class="dashboard-grid">
                    <div class="dash-card">
                        <div class="dash-icon">üí¨</div>
                        <div class="dash-value" id="dTotalChats">0</div>
                        <div class="dash-label">Toplam Sohbet</div>
                    </div>
                    <div class="dash-card green">
                        <div class="dash-icon">üì®</div>
                        <div class="dash-value" id="dTotalMessages">0</div>
                        <div class="dash-label">Toplam Mesaj</div>
                    </div>
                    <div class="dash-card orange">
                        <div class="dash-icon">üë•</div>
                        <div class="dash-value" id="dActiveUsers">0</div>
                        <div class="dash-label">Aktif Kullanƒ±cƒ±</div>
                    </div>
                    <div class="dash-card blue">
                        <div class="dash-icon">üìà</div>
                        <div class="dash-value" id="dAvgMessages">0</div>
                        <div class="dash-label">Ort. Mesaj/Sohbet</div>
                    </div>
                    <div class="dash-card">
                        <div class="dash-icon">üìä</div>
                        <div class="dash-value" id="dWeeklyGrowth">0%</div>
                        <div class="dash-label">Haftalƒ±k B√ºy√ºme</div>
                        <div class="dash-change" id="dWeeklyDetail"></div>
                    </div>
                    <div class="dash-card green">
                        <div class="dash-icon">üìã</div>
                        <div class="dash-value" id="dProfileRate">0%</div>
                        <div class="dash-label">Profil Tamamlama</div>
                    </div>
                </div>

                <!-- Charts Row 1: Daily Messages + Mode Distribution -->
                <div class="chart-row">
                    <div class="chart-box">
                        <h3>üìà G√ºnl√ºk Mesaj Trendi</h3>
                        <div id="dailyChart" class="bar-chart"></div>
                    </div>
                    <div class="chart-box">
                        <h3>üé≠ Mod Daƒüƒ±lƒ±mƒ±</h3>
                        <div id="modeDonut" class="donut-chart"></div>
                        <div id="modeLegend" class="legend"></div>
                    </div>
                </div>

                <!-- Charts Row 2: Hourly Heatmap + DAU -->
                <div class="chart-row">
                    <div class="chart-box">
                        <h3>üïê Saatlik Aktivite Yoƒüunluƒüu</h3>
                        <div id="hourlyHeatmap" class="heatmap"></div>
                        <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:10px;color:#999;">
                            <span>00:00</span><span>06:00</span><span>12:00</span><span>18:00</span><span>23:00</span>
                        </div>
                    </div>
                    <div class="chart-box">
                        <h3>üìä Mesaj Uzunluk Daƒüƒ±lƒ±mƒ±</h3>
                        <div id="lengthChart" class="bar-chart" style="height:130px;"></div>
                    </div>
                </div>

                <!-- Top Users Table -->
                <div class="chart-box" style="margin-bottom:25px;">
                    <h3>üèÜ En Aktif Kullanƒ±cƒ±lar (Top 10)</h3>
                    <table class="data-table" id="topUsersTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Kullanƒ±cƒ±</th>
                                <th>Mesaj</th>
                                <th>Sohbet</th>
                                <th>Ort/Sohbet</th>
                            </tr>
                        </thead>
                        <tbody id="topUsersBody"></tbody>
                    </table>
                </div>

                <!-- DAU Chart -->
                <div class="chart-box" style="margin-bottom:25px;">
                    <h3>üë• G√ºnl√ºk Aktif Kullanƒ±cƒ± (DAU)</h3>
                    <div id="dauChart" class="bar-chart"></div>
                </div>

            </div>

            <!-- ==================== SETTINGS TAB ==================== -->
            <div id="tab-settings" class="tab-content">

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3><span class="emoji">üí¨</span>Toplam Sohbet</h3>
                    <div class="value" id="totalChats">0</div>
                </div>
                <div class="stat-card">
                    <h3><span class="emoji">üì®</span>Toplam Mesaj</h3>
                    <div class="value" id="totalMessages">0</div>
                </div>
                <div class="stat-card">
                    <h3><span class="emoji">‚è±Ô∏è</span>Uptime</h3>
                    <div class="value" id="uptime">0s</div>
                </div>
            </div>

            <!-- Settings -->
            <div class="settings-grid">
                <!-- AI Model Settings -->
                <div class="settings-card">
                    <h2>ü§ñ AI Model Ayarlarƒ±</h2>
                    <div class="form-row">
                        <div class="input-group">
                            <label for="model">Model</label>
                            <select id="model">
                                <option value="gpt-4o-mini">GPT-4o Mini (Hƒ±zlƒ± & Ekonomik)</option>
                                <option value="gpt-4o">GPT-4o (En ƒ∞yi Performans)</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo (En Ekonomik)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="maxMessageLength">Maks. Mesaj Uzunluƒüu</label>
                            <input type="number" id="maxMessageLength" min="100" max="5000" step="100">
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="temperature">Temperature (Yaratƒ±cƒ±lƒ±k): <span class="range-value" id="tempValue">0.7</span></label>
                        <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" 
                               oninput="document.getElementById('tempValue').textContent = this.value">
                    </div>
                    <div class="input-group">
                        <label for="frequencyPenalty">Frequency Penalty (Tekrar Azaltma): <span class="range-value" id="freqValue">0</span></label>
                        <input type="range" id="frequencyPenalty" min="-2" max="2" step="0.1" value="0" 
                               oninput="document.getElementById('freqValue').textContent = this.value">
                        <small style="color: #666; display: block; margin-top: 5px;">Aynƒ± kelimelerin/√ºr√ºnlerin tekrar edilmesini azaltƒ±r (√∂nerilen: 0.3-0.5)</small>
                    </div>
                    <div class="input-group">
                        <label for="presencePenalty">Presence Penalty (Yeni Konulara Ge√ßi≈ü): <span class="range-value" id="presValue">0</span></label>
                        <input type="range" id="presencePenalty" min="-2" max="2" step="0.1" value="0" 
                               oninput="document.getElementById('presValue').textContent = this.value">
                        <small style="color: #666; display: block; margin-top: 5px;">Yeni konularƒ± ke≈üfetmeyi te≈üvik eder, aynƒ± noktada takƒ±lmayƒ± √∂nler (√∂nerilen: 0.3-0.5)</small>
                    </div>
                    <div class="input-group">
                        <label for="topP">Top P (√áe≈üitlilik Kontrol√º): <span class="range-value" id="topPValue">1</span></label>
                        <input type="range" id="topP" min="0" max="1" step="0.05" value="1" 
                               oninput="document.getElementById('topPValue').textContent = this.value">
                        <small style="color: #666; display: block; margin-top: 5px;">Temperature ile birlikte kullanƒ±lmaz, genelde varsayƒ±lan 1'de bƒ±rakƒ±lƒ±r</small>
                    </div>
                    <div class="input-group">
                        <label for="maxTokens">Max Tokens (Maksimum Yanƒ±t Uzunluƒüu)</label>
                        <input type="number" id="maxTokens" min="0" max="4000" step="50" placeholder="Bo≈ü = Sƒ±nƒ±rsƒ±z">
                        <small style="color: #666; display: block; margin-top: 5px;">Yanƒ±tƒ±n maksimum token sayƒ±sƒ± (√∂nerilen: 500-1000, bo≈ü bƒ±rakƒ±lƒ±rsa sƒ±nƒ±rsƒ±z)</small>
                    </div>
                </div>

                <!-- System Prompt -->
                <div class="settings-card">
                    <h2>üß† Ana Sistem Promptu</h2>
                    <div class="input-group">
                        <label for="systemPrompt">AI'ƒ±n genel ki≈üiliƒüi ve davranƒ±≈ü kurallarƒ±</label>
                        <textarea id="systemPrompt" rows="8"></textarea>
                    </div>
                </div>

                <!-- Mode Prompts -->
                <div class="settings-card">
                    <h2>üé≠ Mod Promptlarƒ±</h2>
                    <div class="input-group">
                        <label for="carePrompt">üß¥ Bakƒ±m Modu</label>
                        <textarea id="carePrompt" rows="3"></textarea>
                    </div>
                    <div class="input-group">
                        <label for="motivationPrompt">üí™ Motivasyon Modu</label>
                        <textarea id="motivationPrompt" rows="3"></textarea>
                    </div>
                    <div class="input-group">
                        <label for="dietPrompt">ü•ó Beslenme Modu</label>
                        <textarea id="dietPrompt" rows="3"></textarea>
                    </div>
                </div>

                <!-- Blacklist -->
                <div class="settings-card">
                    <h2>üö´ Kara Liste (Yasaklƒ± Kelimeler)</h2>
                    <div class="blacklist-manager">
                        <div class="blacklist-tags" id="blacklistTags"></div>
                        <div class="add-blacklist">
                            <input type="text" id="newBlacklistWord" placeholder="Yeni kelime ekle...">
                            <button class="btn" onclick="addBlacklistWord()">Ekle</button>
                        </div>
                    </div>
                </div>

                <!-- Push Notifications -->
                <div class="settings-card">
                    <h2>üîî Push Bildirimleri</h2>
                    <div id="pushStats" style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <div style="background: #f0f0f0; padding: 15px 25px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="pushSubscriberCount">0</div>
                            <div style="font-size: 12px; color: #666;">Abone Kullanƒ±cƒ±</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 15px; color: #333;">üì§ Test Bildirimi G√∂nder</h3>
                    <div class="input-group">
                        <label for="pushTitle">Ba≈ülƒ±k</label>
                        <input type="text" id="pushTitle" placeholder="Bildirim ba≈ülƒ±ƒüƒ±..." value="Women AI üíú">
                    </div>
                    <div class="input-group">
                        <label for="pushBody">Mesaj</label>
                        <textarea id="pushBody" rows="3" placeholder="Bildirim mesajƒ±...">Merhaba! Women AI'dan bir mesajƒ±nƒ±z var üå∏</textarea>
                    </div>
                    <div class="input-group">
                        <label for="pushUrl">Tƒ±klanƒ±nca A√ßƒ±lacak URL (opsiyonel)</label>
                        <input type="text" id="pushUrl" placeholder="https://singapur.semihcankadioglu.com.tr">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="sendTestPush()" id="sendTestPushBtn">üöÄ Test Bildirimi G√∂nder</button>
                        <button class="btn btn-secondary" onclick="sendBroadcastPush()" id="broadcastPushBtn">üì¢ T√ºm Kullanƒ±cƒ±lara G√∂nder</button>
                    </div>
                    <div id="pushResult" style="margin-top: 15px; padding: 10px; border-radius: 8px; display: none;"></div>
                </div>

                <!-- Save Button -->
                <div class="settings-card">
                    <button class="btn" onclick="saveSettings()">üíæ Ayarlarƒ± Kaydet</button>
                    <button class="btn btn-secondary" onclick="loadSettings()">üîÑ Ayarlarƒ± Yenile</button>
                </div>
            </div>

            </div><!-- /tab-settings -->

        </div>
    </div>

    <script>
        let token = localStorage.getItem('adminToken');
        let currentSettings = null;

        // Init
        window.onload = () => {
            document.getElementById('loading').style.display = 'none';
            if (token) {
                showAdminPanel();
            } else {
                showLogin();
            }
        };

        function showLogin() {
            document.getElementById('loginBox').classList.add('active');
            document.getElementById('adminPanel').classList.remove('active');
        }

        function showAdminPanel() {
            document.getElementById('loginBox').classList.remove('active');
            document.getElementById('adminPanel').classList.add('active');
            loadStats();
            loadSettings();
        }

        function showAlert(message, type = 'success', elementId = 'mainAlert') {
            const alert = document.getElementById(elementId);
            alert.textContent = message;
            alert.className = `alert ${type === 'success' ? 'alert-success' : 'alert-error'} active`;
            setTimeout(() => alert.classList.remove('active'), 5000);
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const res = await fetch('/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await res.json();

                if (res.ok) {
                    token = data.token;
                    localStorage.setItem('adminToken', token);
                    showAdminPanel();
                } else {
                    showAlert(data.error || 'Giri≈ü ba≈üarƒ±sƒ±z', 'error', 'loginAlert');
                }
            } catch (err) {
                showAlert('Baƒülantƒ± hatasƒ±: ' + err.message, 'error', 'loginAlert');
            }
        });

        // Logout
        async function logout() {
            try {
                await fetch('/admin/logout', {
                    method: 'POST',
                    headers: { 'x-admin-token': token }
                });
            } catch (err) {
                console.error('Logout error:', err);
            }
            token = null;
            localStorage.removeItem('adminToken');
            showLogin();
        }

        // Load Stats
        async function loadStats() {
            try {
                const res = await fetch('/admin/stats', {
                    headers: { 'x-admin-token': token }
                });

                if (res.status === 401) {
                    logout();
                    return;
                }

                const data = await res.json();
                document.getElementById('totalChats').textContent = data.totalChats;
                document.getElementById('totalMessages').textContent = data.totalMessages;
                document.getElementById('uptime').textContent = formatUptime(data.uptime);
            } catch (err) {
                console.error('Stats error:', err);
            }
        }

        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}s ${minutes}d`;
        }

        // Load Settings
        async function loadSettings() {
            try {
                const res = await fetch('/admin/settings', {
                    headers: { 'x-admin-token': token }
                });

                if (res.status === 401) {
                    logout();
                    return;
                }

                currentSettings = await res.json();

                // Populate form
                document.getElementById('systemPrompt').value = currentSettings.systemPrompt || '';
                document.getElementById('carePrompt').value = currentSettings.carePrompt || '';
                document.getElementById('motivationPrompt').value = currentSettings.motivationPrompt || '';
                document.getElementById('dietPrompt').value = currentSettings.dietPrompt || '';
                document.getElementById('temperature').value = currentSettings.temperature || 0.4;
                document.getElementById('tempValue').textContent = currentSettings.temperature || 0.4;
                document.getElementById('model').value = currentSettings.model || 'gpt-4o-mini';
                document.getElementById('maxMessageLength').value = currentSettings.maxMessageLength || 1000;
                
                // Yeni parametreler
                document.getElementById('frequencyPenalty').value = currentSettings.frequencyPenalty || 0;
                document.getElementById('freqValue').textContent = currentSettings.frequencyPenalty || 0;
                document.getElementById('presencePenalty').value = currentSettings.presencePenalty || 0;
                document.getElementById('presValue').textContent = currentSettings.presencePenalty || 0;
                document.getElementById('topP').value = currentSettings.topP !== undefined ? currentSettings.topP : 1;
                document.getElementById('topPValue').textContent = currentSettings.topP !== undefined ? currentSettings.topP : 1;
                document.getElementById('maxTokens').value = currentSettings.maxTokens || '';

                // Render blacklist
                renderBlacklist(currentSettings.blacklist || []);

                showAlert('Ayarlar y√ºklendi', 'success');
            } catch (err) {
                showAlert('Ayarlar y√ºklenirken hata: ' + err.message, 'error');
            }
        }

        // Save Settings
        async function saveSettings() {
            const maxTokensValue = document.getElementById('maxTokens').value;
            
            const settings = {
                systemPrompt: document.getElementById('systemPrompt').value,
                carePrompt: document.getElementById('carePrompt').value,
                motivationPrompt: document.getElementById('motivationPrompt').value,
                dietPrompt: document.getElementById('dietPrompt').value,
                temperature: parseFloat(document.getElementById('temperature').value),
                model: document.getElementById('model').value,
                maxMessageLength: parseInt(document.getElementById('maxMessageLength').value),
                blacklist: currentSettings ? currentSettings.blacklist : [],
                frequencyPenalty: parseFloat(document.getElementById('frequencyPenalty').value),
                presencePenalty: parseFloat(document.getElementById('presencePenalty').value),
                topP: parseFloat(document.getElementById('topP').value),
                maxTokens: maxTokensValue ? parseInt(maxTokensValue) : null
            };

            try {
                const res = await fetch('/admin/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-token': token
                    },
                    body: JSON.stringify(settings)
                });

                if (res.status === 401) {
                    logout();
                    return;
                }

                const data = await res.json();

                if (res.ok) {
                    showAlert('‚úÖ Ayarlar ba≈üarƒ±yla kaydedildi!', 'success');
                    currentSettings = data.settings;
                } else {
                    showAlert('Hata: ' + data.error, 'error');
                }
            } catch (err) {
                showAlert('Kayƒ±t hatasƒ±: ' + err.message, 'error');
            }
        }

        // Blacklist Management
        function renderBlacklist(blacklist) {
            const container = document.getElementById('blacklistTags');
            container.innerHTML = '';

            if (!blacklist || blacklist.length === 0) {
                container.innerHTML = '<div style="color: #999; padding: 10px;">Hen√ºz kara listede kelime yok</div>';
                return;
            }

            blacklist.forEach((word, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    <span>${word}</span>
                    <span class="remove" onclick="removeBlacklistWord(${index})">√ó</span>
                `;
                container.appendChild(tag);
            });
        }

        function addBlacklistWord() {
            const input = document.getElementById('newBlacklistWord');
            const word = input.value.trim();

            if (!word) return;

            if (!currentSettings.blacklist) {
                currentSettings.blacklist = [];
            }

            if (currentSettings.blacklist.includes(word)) {
                showAlert('Bu kelime zaten listede', 'error');
                return;
            }

            currentSettings.blacklist.push(word);
            renderBlacklist(currentSettings.blacklist);
            input.value = '';
            showAlert(`"${word}" kara listeye eklendi (kaydetmeyi unutma!)`, 'success');
        }

        function removeBlacklistWord(index) {
            const word = currentSettings.blacklist[index];
            currentSettings.blacklist.splice(index, 1);
            renderBlacklist(currentSettings.blacklist);
            showAlert(`"${word}" kara listeden √ßƒ±karƒ±ldƒ± (kaydetmeyi unutma!)`, 'success');
        }

        // Enter key for blacklist
        document.getElementById('newBlacklistWord').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addBlacklistWord();
            }
        });

        // Auto-refresh stats every 30 seconds
        setInterval(() => {
            if (token && document.getElementById('adminPanel').classList.contains('active')) {
                loadStats();
            }
        }, 30000);

        // ========== PUSH NOTIFICATIONS ==========
        
        // Push abone sayƒ±sƒ±nƒ± y√ºkle
        async function loadPushStats() {
            try {
                const res = await fetch('/api/push/stats', {
                    headers: { 'x-admin-token': token }
                });
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('pushSubscriberCount').textContent = data.subscriberCount || 0;
                }
            } catch (err) {
                console.error('Push stats y√ºklenemedi:', err);
            }
        }

        // Test bildirimi g√∂nder (sadece admin'e)
        async function sendTestPush() {
            const title = document.getElementById('pushTitle').value.trim();
            const body = document.getElementById('pushBody').value.trim();
            const url = document.getElementById('pushUrl').value.trim();
            const resultDiv = document.getElementById('pushResult');
            const btn = document.getElementById('sendTestPushBtn');

            if (!title || !body) {
                showPushResult('Ba≈ülƒ±k ve mesaj gerekli!', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = '‚è≥ G√∂nderiliyor...';

            try {
                const res = await fetch('/api/push/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-token': token
                    },
                    body: JSON.stringify({ title, body, url })
                });

                const data = await res.json();

                if (res.ok) {
                    showPushResult(`‚úÖ Test bildirimi g√∂nderildi! (${data.successCount || 1} ba≈üarƒ±lƒ±)`, 'success');
                } else {
                    showPushResult(`‚ùå Hata: ${data.error}`, 'error');
                }
            } catch (err) {
                showPushResult(`‚ùå Baƒülantƒ± hatasƒ±: ${err.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Test Bildirimi G√∂nder';
            }
        }

        // T√ºm kullanƒ±cƒ±lara broadcast g√∂nder
        async function sendBroadcastPush() {
            const title = document.getElementById('pushTitle').value.trim();
            const body = document.getElementById('pushBody').value.trim();
            const url = document.getElementById('pushUrl').value.trim();
            const btn = document.getElementById('broadcastPushBtn');

            if (!title || !body) {
                showPushResult('Ba≈ülƒ±k ve mesaj gerekli!', 'error');
                return;
            }

            if (!confirm(`"${title}" ba≈ülƒ±klƒ± bildirimi T√úM kullanƒ±cƒ±lara g√∂ndermek istediƒüinize emin misiniz?`)) {
                return;
            }

            btn.disabled = true;
            btn.textContent = '‚è≥ G√∂nderiliyor...';

            try {
                const res = await fetch('/api/push/broadcast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-token': token
                    },
                    body: JSON.stringify({ title, body, url })
                });

                const data = await res.json();

                if (res.ok) {
                    showPushResult(`‚úÖ Broadcast g√∂nderildi! ${data.successCount} ba≈üarƒ±lƒ±, ${data.failureCount} ba≈üarƒ±sƒ±z`, 'success');
                } else {
                    showPushResult(`‚ùå Hata: ${data.error}`, 'error');
                }
            } catch (err) {
                showPushResult(`‚ùå Baƒülantƒ± hatasƒ±: ${err.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üì¢ T√ºm Kullanƒ±cƒ±lara G√∂nder';
            }
        }

        function showPushResult(message, type) {
            const resultDiv = document.getElementById('pushResult');
            resultDiv.textContent = message;
            resultDiv.style.display = 'block';
            resultDiv.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
            resultDiv.style.color = type === 'success' ? '#155724' : '#721c24';
            
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 5000);
        }

        // Panel a√ßƒ±ldƒ±ƒüƒ±nda push stats'ƒ± da y√ºkle
        const originalShowAdminPanel = showAdminPanel;
        showAdminPanel = function() {
            originalShowAdminPanel();
            loadPushStats();
            loadChatStats(30);
        };

        // ========== TAB NAVƒ∞GASYON ==========
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // ========== SOHBET ƒ∞STATƒ∞STƒ∞KLERƒ∞ DASHBOARD ==========
        let chatStatsData = null;

        async function loadChatStats(days = 30) {
            // Period buton aktif
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.period-btn[data-period="${days}"]`)?.classList.add('active');

            try {
                const [statsRes, chatStatsRes] = await Promise.all([
                    fetch('/admin/stats', { headers: { 'x-admin-token': token } }),
                    fetch(`/admin/chat-stats?days=${days}`, { headers: { 'x-admin-token': token } }),
                ]);

                if (statsRes.status === 401 || chatStatsRes.status === 401) { logout(); return; }

                const stats = await statsRes.json();
                const data = await chatStatsRes.json();
                chatStatsData = data;

                // Summary cards
                document.getElementById('dTotalChats').textContent = stats.totalChats.toLocaleString();
                document.getElementById('dTotalMessages').textContent = stats.totalMessages.toLocaleString();
                document.getElementById('dActiveUsers').textContent = data.activeUsers.toLocaleString();
                document.getElementById('dAvgMessages').textContent = data.avgMessagesPerChat.avg;

                const growth = data.weeklyComparison.growth;
                const growthEl = document.getElementById('dWeeklyGrowth');
                growthEl.textContent = (growth >= 0 ? '+' : '') + growth + '%';
                growthEl.style.color = growth >= 0 ? '#38ef7d' : '#f5576c';
                document.getElementById('dWeeklyDetail').textContent =
                    `Bu hafta: ${data.weeklyComparison.thisWeek} | Ge√ßen: ${data.weeklyComparison.prevWeek}`;
                document.getElementById('dWeeklyDetail').className =
                    'dash-change ' + (growth >= 0 ? 'up' : 'down');

                document.getElementById('dProfileRate').textContent = data.profileCompletion.rate + '%';

                // Also update settings tab stats
                document.getElementById('totalChats').textContent = stats.totalChats;
                document.getElementById('totalMessages').textContent = stats.totalMessages;
                document.getElementById('uptime').textContent = formatUptime(stats.uptime);

                // Render charts
                renderDailyChart(data.dailyMessages);
                renderModeDonut(data.modeDistribution);
                renderHourlyHeatmap(data.hourlyMessages);
                renderLengthChart(data.messageLengths);
                renderTopUsers(data.topUsers);
                renderDAUChart(data.dailyActiveUsers);

            } catch (err) {
                console.error('Chat stats error:', err);
            }
        }

        // G√ºnl√ºk mesaj bar chart
        function renderDailyChart(data) {
            const container = document.getElementById('dailyChart');
            if (!data || data.length === 0) {
                container.innerHTML = '<div style="color:#999;text-align:center;padding:40px;">Veri yok</div>';
                return;
            }
            const max = Math.max(...data.map(d => d.count), 1);
            // Son 14 g√ºn g√∂ster
            const recent = data.slice(-14);
            container.innerHTML = recent.map(d => {
                const h = Math.max((d.count / max) * 100, 2);
                const date = d._id.slice(5); // MM-DD
                return `<div class="bar-col">
                    <div class="bar-value">${d.count}</div>
                    <div class="bar" style="height:${h}%" title="${d._id}: ${d.count} mesaj (${d.userMsgs}üë§ ${d.aiMsgs}ü§ñ)"></div>
                    <div class="bar-label">${date}</div>
                </div>`;
            }).join('');
        }

        // Mod daƒüƒ±lƒ±mƒ± donut
        function renderModeDonut(data) {
            const donut = document.getElementById('modeDonut');
            const legend = document.getElementById('modeLegend');
            if (!data || data.length === 0) {
                donut.innerHTML = '<div style="color:#999;text-align:center;padding:40px;">Veri yok</div>';
                legend.innerHTML = '';
                return;
            }
            const colors = { care: '#667eea', motivation: '#f093fb', diet: '#38ef7d' };
            const labels = { care: 'üß¥ Bakƒ±m', motivation: 'üí™ Motivasyon', diet: 'ü•ó Beslenme' };
            const total = data.reduce((s, d) => s + d.count, 0);

            let gradient = 'conic-gradient(';
            let offset = 0;
            data.forEach((d, i) => {
                const pct = (d.count / total) * 100;
                const color = colors[d._id] || '#ccc';
                gradient += `${color} ${offset}% ${offset + pct}%`;
                if (i < data.length - 1) gradient += ', ';
                offset += pct;
            });
            gradient += ')';

            donut.style.background = gradient;
            donut.innerHTML = `<div class="donut-center">${total}</div>`;

            legend.innerHTML = data.map(d => {
                const pct = Math.round((d.count / total) * 100);
                return `<div class="legend-item">
                    <div class="legend-dot" style="background:${colors[d._id] || '#ccc'}"></div>
                    <span>${labels[d._id] || d._id} ‚Äî ${d.count} (${pct}%)</span>
                </div>`;
            }).join('');
        }

        // Saatlik heatmap
        function renderHourlyHeatmap(data) {
            const container = document.getElementById('hourlyHeatmap');
            const hourMap = {};
            (data || []).forEach(d => { hourMap[d._id] = d.count; });
            const max = Math.max(...Object.values(hourMap), 1);

            let html = '';
            for (let h = 0; h < 24; h++) {
                const count = hourMap[h] || 0;
                const intensity = count / max;
                const r = Math.round(102 + (245 - 102) * (1 - intensity));
                const g = Math.round(126 + (87 - 126) * intensity);
                const b = Math.round(234 + (162 - 234) * intensity);
                const bg = count === 0 ? '#e8e8e8' : `rgba(102,126,234,${0.15 + intensity * 0.85})`;
                const textColor = intensity > 0.5 ? 'white' : '#666';
                html += `<div class="heat-cell" style="background:${bg};color:${textColor}" title="${h}:00 - ${count} mesaj">${count || ''}</div>`;
            }
            container.innerHTML = html;
        }

        // Mesaj uzunluk daƒüƒ±lƒ±mƒ±
        function renderLengthChart(data) {
            const container = document.getElementById('lengthChart');
            if (!data || data.length === 0) {
                container.innerHTML = '<div style="color:#999;text-align:center;padding:30px;">Veri yok</div>';
                return;
            }
            const labels = { 0: '0-50', 50: '50-100', 100: '100-200', 200: '200-500', 500: '500-1K', 1000: '1K+', '5000+': '5K+' };
            const max = Math.max(...data.map(d => d.count), 1);
            container.innerHTML = data.map(d => {
                const h = Math.max((d.count / max) * 100, 3);
                const label = labels[d._id] || d._id;
                return `<div class="bar-col">
                    <div class="bar-value">${d.count}</div>
                    <div class="bar" style="height:${h}%;background:linear-gradient(to top,#38ef7d,#11998e)"></div>
                    <div class="bar-label">${label}</div>
                </div>`;
            }).join('');
        }

        // Top users table
        function renderTopUsers(data) {
            const body = document.getElementById('topUsersBody');
            if (!data || data.length === 0) {
                body.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;padding:20px;">Veri yok</td></tr>';
                return;
            }
            const medalColors = ['#FFD700', '#C0C0C0', '#CD7F32'];
            body.innerHTML = data.map((u, i) => {
                const bg = i < 3 ? medalColors[i] : '#667eea';
                const avg = u.chatCount > 0 ? Math.round(u.totalMessages / u.chatCount * 10) / 10 : 0;
                return `<tr>
                    <td><span class="rank-badge" style="background:${bg}">${i + 1}</span></td>
                    <td>${u.name}</td>
                    <td><strong>${u.totalMessages}</strong></td>
                    <td>${u.chatCount}</td>
                    <td>${avg}</td>
                </tr>`;
            }).join('');
        }

        // DAU chart
        function renderDAUChart(data) {
            const container = document.getElementById('dauChart');
            if (!data || data.length === 0) {
                container.innerHTML = '<div style="color:#999;text-align:center;padding:40px;">Veri yok</div>';
                return;
            }
            const max = Math.max(...data.map(d => d.activeUsers), 1);
            const recent = data.slice(-14);
            container.innerHTML = recent.map(d => {
                const h = Math.max((d.activeUsers / max) * 100, 3);
                const date = d._id.slice(5);
                return `<div class="bar-col">
                    <div class="bar-value">${d.activeUsers}</div>
                    <div class="bar" style="height:${h}%;background:linear-gradient(to top,#4facfe,#00f2fe)"></div>
                    <div class="bar-label">${date}</div>
                </div>`;
            }).join('');
        }
    </script>
</body>
</html>
